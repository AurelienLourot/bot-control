# OpenStack Charm CI - openstack-bundles jobs approach #000 - works ok, but is a bit too verbatim.
- job-template:
    name: '{name}-{bundle-name}-{arch}'
    description: |
        <p>Exercise an openstack-bundles type bundle: {name} {bundle-file} {arch}.</p>
        <p><i>Dynamically Generated Job - Do not edit through the Jenkins Web UI.  You will lose your changes.</i></p>
    node: '{node-foo}'
    parameters: 
        - string:
            name: BUNDLE_FILE
            default: '{bundle-file}'
            description: Bundle file (relative path to bundle checkout directory).
        - string:
            name: ARCH
            default: '{arch}'
            description: CPU architecture.
        - DISPLAY_NAME
    build-discarder:
      artifactDaysToKeep: 365
      artifactNumToKeep: 500
    triggers:
      - timed: '{cron-foo}'
    wrappers:
      - workspace-cleanup
      - timestamps
      - timeout:
          type: elastic
          fail: false
          abort: true
          elastic-number-builds: 10
          elastic-default-timeout: 240
    builders:
      - prep_osci_repo_if_necessary
      - build_openstack_bundles_runner
    publishers:
      - archive_artifacts
      - email_watchers

- project:
    name: bundle-next
    bundle-name:
      - openstack-base-xenial-mitaka:
          bundle-file: development/openstack-base-xenial-mitaka/bundle.yaml
      - openstack-base-xenial-newton:
          bundle-file: development/openstack-base-xenial-newton/bundle.yaml
      - openstack-base-xenial-ocata:
          bundle-file: development/openstack-base-xenial-ocata/bundle.yaml
      - openstack-base-xenial-pike:
          bundle-file: development/openstack-base-xenial-pike/bundle.yaml

      - openstack-telemetry-xenial-mitaka:
          bundle-file: development/openstack-telemetry-xenial-mitaka/bundle/yaml
      - openstack-telemetry-xenial-newton:
          bundle-file: development/openstack-telemetry-xenial-newton/bundle/yaml
      - openstack-telemetry-xenial-ocata:
          bundle-file: development/openstack-telemetry-xenial-ocata/bundle/yaml
      - openstack-telemetry-xenial-pike:
          bundle-file: development/openstack-telemetry-xenial-pike/bundle/yaml

      - openstack-lxd-xenial-mitaka:
          bundle-file: development/openstack-lxd-xenial-mitaka/bundle.yaml
      - openstack-lxd-xenial-newton:
          bundle-file: development/openstack-lxd-xenial-newton/bundle.yaml
      - openstack-lxd-xenial-ocata:
          bundle-file: development/openstack-lxd-xenial-ocata/bundle.yaml
      - openstack-lxd-xenial-pike:
          bundle-file: development/openstack-lxd-xenial-pike/bundle.yaml

    # Pivot all architectures by default; exclude by exception where not applicable.
    arch:
      - amd64:
          node-foo: 'osci-lab-0'
          cron-foo: 'H H * * 0'
      - aarch64:
          node-foo: 'osci-lab-1'
          cron-foo: 'H H * * 1'
      - ppc64el:
          node-foo: 'osci-lab-2'
          cron-foo: 'H H * * 2'

    # Optionally exclude certain combos
    exclude:
      - bundle-name: openstack-base-xenial-pike
      - bundle-name: openstack-telemetry-xenial-pike
      - bundle-name: openstack-lxd-xenial-mitaka
      - bundle-name: openstack-lxd-xenial-newton
      - bundle-name: openstack-lxd-xenial-ocata
      - bundle-name: openstack-lxd-xenial-pike
    # - bundle-name: openstack-telemetry-trusty-icehouse
    #   arch: s390x
    jobs:
      - '{name}-{bundle-name}-{arch}'

- project:
    name: bundle-stable
    bundle-name:
      - openstack-base-xenial-mitaka:
          bundle-file: stable/openstack-base-xenial-mitaka/bundle.yaml
      - openstack-base-xenial-newton:
          bundle-file: stable/openstack-base-xenial-newton/bundle.yaml
      - openstack-base-xenial-ocata:
          bundle-file: stable/openstack-base-xenial-ocata/bundle.yaml
      - openstack-base-xenial-pike:
          bundle-file: stable/openstack-base-xenial-pike/bundle.yaml

      - openstack-telemetry-xenial-mitaka:
          bundle-file: stable/openstack-telemetry-xenial-mitaka/bundle/yaml
      - openstack-telemetry-xenial-newton:
          bundle-file: stable/openstack-telemetry-xenial-newton/bundle/yaml
      - openstack-telemetry-xenial-ocata:
          bundle-file: stable/openstack-telemetry-xenial-ocata/bundle/yaml
      - openstack-telemetry-xenial-pike:
          bundle-file: stable/openstack-telemetry-xenial-pike/bundle/yaml

      - openstack-lxd-xenial-mitaka:
          bundle-file: stable/openstack-lxd-xenial-mitaka/bundle.yaml
      - openstack-lxd-xenial-newton:
          bundle-file: stable/openstack-lxd-xenial-newton/bundle.yaml
      - openstack-lxd-xenial-ocata:
          bundle-file: stable/openstack-lxd-xenial-ocata/bundle.yaml
      - openstack-lxd-xenial-pike:
          bundle-file: stable/openstack-lxd-xenial-pike/bundle.yaml
    arch:
      - amd64:
          node-foo: 'osci-lab-0'
          cron-foo: 'H H * * 3'
      - aarch64:
          node-foo: 'osci-lab-1'
          cron-foo: 'H H * * 4'
      - ppc64el:
          node-foo: 'osci-lab-2'
          cron-foo: 'H H * * 5'
    # Optionally exclude certain combos
    exclude:
      - 'bundle-name': openstack-base-xenial-pike
      - 'bundle-name': openstack-telemetry-xenial-pike
      # openstack-lxd bundles need to be updated and validated before enabling
      - 'bundle-name': openstack-lxd-xenial-mitaka
      - 'bundle-name': openstack-lxd-xenial-newton
      - 'bundle-name': openstack-lxd-xenial-ocata
      - 'bundle-name': openstack-lxd-xenial-pike
    # - 'bundle-name': openstack-telemetry-trusty-icehouse
    #   arch: s390x
    jobs:
      - '{name}-{bundle-name}-{arch}'

- builder:
    name: build_openstack_bundles_runner
    builders:
      - shell: |
          #!/bin/bash -ue
          . ~/oscirc
          ${OSCI_ROOT}/run/job-parts/build_openstack_bundles_runner.sh

- view:
    name: OB
    description: |
        <p>OpenStack-Bundles jobs</p>
    view-type: list
    regex: "bundle-.*openstack.*"
    columns:
      - status
      - build-button
      - weather
      - job
      - last-success
      - last-failure
